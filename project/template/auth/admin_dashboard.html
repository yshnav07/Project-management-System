<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom Styles -->
  <style>
    body {
      background: #f8fafc;
      font-family: 'Segoe UI', sans-serif;
    }
    .navbar {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    }
    .navbar-brand, .nav-link {
      color: #fff !important;
      font-weight: 600;
    }
    .dropdown-menu {
      border-radius: 8px;
      padding: 0.5rem;
    }
    .dropdown-item {
      color: #000 !important;
      font-weight: 500;
    }
    .dropdown-item:hover {
      background: #f1f5f9;
    }
    .card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .btn-gradient {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white !important;
      font-weight: 500;
      border-radius: 10px;
      padding: 12px;
      transition: 0.3s;
    }
    .btn-gradient:hover {
      background: linear-gradient(135deg, #5a0eb5 0%, #1e63d0 100%);
    }
    .btn-outline-secondary {
      font-weight: 500;
      border-radius: 10px;
      padding: 12px;
    }
    footer {
      text-align: center;
      padding: 20px;
      font-size: 0.9rem;
      color: #64748b;
      border-top: 1px solid #e2e8f0;
      background: #f9fafb;
      margin-top: 50px;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg px-3">
    <a class="navbar-brand" href="#">Admin Dashboard </a>
    <div class="ms-auto">
      <ul class="navbar-nav">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
            {{ request.user.get_full_name|default:request.user.username }}
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <form method="post" action="{% url 'admin-logout' %}">
                {% csrf_token %}
                <button type="submit" class="dropdown-item">ğŸšª Logout</button>
              </form>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container my-4">

    <!-- Header -->
    <div class="text-center mb-5">
      <h3>Welcome, {{ request.user.get_full_name|default:request.user.username }}</h3>
      <small class="text-muted">You are logged in as <b>Superuser</b></small>
    </div>

    <!-- Stats -->
    <div class="row justify-content-center g-4 mb-5">
      <div class="col-sm-6 col-md-3">
        <div class="card p-3 text-center">
          <small class="text-muted">ğŸ§‘â€ğŸ« Total Guides</small>
          <h4 class="mt-2">{{ guides_count|default:0 }}</h4>
        </div>
      </div>
      <div class="col-sm-6 col-md-3">
        <div class="card p-3 text-center">
          <small class="text-muted">ğŸ“ Total Students</small>
          <h4 class="mt-2">{{ students_count|default:0 }}</h4>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Left Panel -->
      <div class="col-lg-4 d-flex flex-column gap-4">

        <!-- Quick Actions -->
        <div class="card shadow-sm p-4">
          <h5 class="mb-3">âš¡ Quick Actions</h5>
          <div class="d-flex flex-column gap-3">
            <a class="btn btn-gradient w-100" href="{% url 'manage-guides' %}">ğŸ“‹ Manage Guides</a>
            <a class="btn btn-gradient w-100" href="{% url 'manage-students' %}">ğŸ“ Manage Students</a>
            <a class="btn btn-outline-secondary w-100" href="{% url 'add-user' %}">â• Add User</a>
          </div>
        </div>

        <!-- Guide Selector -->
        <div class="card p-3">
          <h6 class="fw-bold mb-2">Select Guide</h6>
          <form method="get">
            <select name="guide" id="guide" class="form-select" onchange="this.form.submit()">
              <option value="">-- Choose Guide --</option>
              {% for g in guides %}
                <option value="{{ g.id }}" {% if selected_guide and g.id == selected_guide.id %}selected{% endif %}>
                  {{ g.get_full_name|default:g.username }}
                </option>
              {% endfor %}
            </select>
          </form>
        </div>

        {% if selected_guide %}
        <!-- Guide Info -->
        <div class="card p-3">
          <h6 class="fw-bold mb-2">Guide Info</h6>
          <p><b>Name:</b> {{ selected_guide.get_full_name|default:selected_guide.username }}</p>
          <p><b>Username:</b> {{ selected_guide.username }}</p>
          <p><b>Assigned Students:</b> {{ guide_students.count|default:0 }}</p>
        </div>
        {% endif %}
      </div>

      <!-- Right Panel -->
      <div class="col-lg-8 d-flex flex-column gap-4">

        <!-- Guide Distribution -->
        <div class="card p-3">
          <h6 class="fw-bold mb-3">ğŸ“Š Guide Distribution</h6>
          {% if selected_guide %}
            <p class="small text-muted mb-2">Distribution for <b>{{ selected_guide.get_full_name|default:selected_guide.username }}</b></p>
            <canvas id="guidePieChart" style="max-height:320px;"></canvas>
          {% else %}
            <p class="small text-muted mb-2">Select a guide to view distribution.</p>
            <canvas id="globalPieChart" style="max-height:320px;"></canvas>
          {% endif %}
        </div>

        {% if selected_guide %}
        <!-- Students + Assignments -->
        <div class="row g-4">
          <div class="col-md-6">
            <div class="card p-3">
              <h6 class="fw-bold mb-3">ğŸ‘¥ Students ({{ guide_students.count|default:0 }})</h6>
              {% if guide_students %}
                <ul class="list-group list-group-flush">
                  {% for s in guide_students %}
                    <li class="list-group-item">
                      {{ s.get_full_name|default:s.username }}
                      <small class="text-muted d-block">{{ s.email }}</small>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted">No students.</p>
              {% endif %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="card p-3">
              <h6 class="fw-bold mb-3">ğŸ“š Assignments ({{ guide_assignments.count|default:0 }})</h6>
              {% if guide_assignments %}
                <ul class="list-group list-group-flush">
                  {% for a in guide_assignments %}
                    <li class="list-group-item">
                      <b>{{ a.title }}</b>
                      <div class="small text-muted">Due: {{ a.due_date|default:"â€”" }}</div>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted">No assignments.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Projects -->
        <div class="card p-3">
          <h6 class="fw-bold mb-3">ğŸ“‚ Projects ({{ guide_projects.count|default:0 }})</h6>
          {% if guide_projects %}
            <div class="table-responsive">
              <table class="table mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Title</th>
                    <th>Student</th>
                    <th>Progress</th>
                    <th>Due</th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in guide_projects %}
                  <tr>
                    <td>{{ p.title }}</td>
                    <td>{% if p.student %}{{ p.student.get_full_name|default:p.student.username }}{% else %}<span class="text-muted">Unassigned</span>{% endif %}</td>
                    <td>
                      <div class="progress" style="height:10px;">
                        <div class="progress-bar" role="progressbar" style="width:{{ p.progress }}%; background:linear-gradient(90deg,#6b21a8,#9333ea)"></div>
                      </div>
                      <small>{{ p.progress }}%</small>
                    </td>
                    <td>{{ p.due_date|default:"â€”" }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted">No projects.</p>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
    <footer>
    Â© 2025 Christ University | Project Management System
  </footer>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    {% if not selected_guide %}
    const ctxGlobal = document.getElementById('globalPieChart');
    if (ctxGlobal) {
      new Chart(ctxGlobal, {
        type: 'pie',
        data: {
          labels: ['Students', 'Guides', 'Admins'],
          datasets: [{
            data: [{{ students_count|default:0 }}, {{ guides_count|default:0 }}, {{ admins_count|default:0 }}],
            backgroundColor: ['#3b82f6', '#9333ea', '#f59e0b']
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }
    {% endif %}

    {% if selected_guide %}
    const ctxGuide = document.getElementById('guidePieChart');
    if (ctxGuide) {
      new Chart(ctxGuide, {
        type: 'pie',
        data: {
          labels: ['Students', 'Assignments', 'Projects'],
          datasets: [{
            data: [{{ guide_students.count|default:0 }}, {{ guide_assignments.count|default:0 }}, {{ guide_projects.count|default:0 }}],
            backgroundColor: ['#10b981', '#0ea5e9', '#6b21a8']
          }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }
    {% endif %}
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
